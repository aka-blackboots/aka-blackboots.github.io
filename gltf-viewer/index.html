<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="./style.css">
  <title>GLTF View</title>
</head>
<body>
<div class="full-screen" id="container"></div>
<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
        "three/examples/jsm/libs/lil-gui.module.min": "https://unpkg.com/three@0.152.2/examples/jsm/libs/lil-gui.module.min.js"
      }
    }
</script>
<script type="module">
  import { DigitalTwinService } from './digital-twin-service.js';
  import * as dat from 'three/examples/jsm/libs/lil-gui.module.min';

  const container = document.getElementById('container');
  const digitalTwin = new DigitalTwinService(container);
  digitalTwin.scene.toggleStats(true);

  const controls = {
    "Poly 3": {
        "raw": {
            "visible": true,
            "url": "./glb/poly3.glb",
        },
        "optimized": {
            "visible": false,
            "url": "./glb/poly3_optimized.glb"
        },
        "transformation": [
                0.9998097028830188,
                0,
                0.01950789637478535,
                0,
                0,
                1,
                0,
                0,
                -0.01950789637478535,
                0,
                0.9998097028830188,
                0,
                -73.85123979193439,
                8.263171570231663,
                -2.2966334555609027,
            ]
    },
    "Poly 4": {
        "raw": {
            "visible": true,
            "url": "./glb/poly4.glb"
        },
        "optimized": {
            "visible": false,
            "url": "./glb/poly4_optimized.glb"
        },
        "transformation": [
                -0.0005622019595995307,
                0,
                0.898642364413135,
                0,
                0,
                0.8986425402734246,
                0,
                0,
                -0.898642364413135,
                0,
                -0.0005622019595995307,
                0,
                -38.0598059344784,
                18.239177486751668,
                -0.8471176644525928,
                1
            ]
    },
    "Poly 5": {
        "raw": {
            "visible": true,
            "url": "./glb/poly5.glb"
        },
        "optimized": {
            "visible": false,
            "url": "./glb/poly5_optimized.glb"
        },
        "transformation": [
                -0.0002495874271465708,
                -0.02995366820268749,
                0.9269549721020576,
                0,
                -0.052313134413672954,
                0.9254796672800424,
                0.029891909548293613,
                0,
                -0.925962244646799,
                -0.05227779691063591,
                -0.0019386274105956125,
                0,
                -15.912024519257438,
                -1.3298717876955566,
                5.433454054737491,
                1
            ]
    },
    "Poly 6": {
        "raw": {
            "visible": true,
            "url": "./glb/poly6.glb"
        },
        "optimized": {
            "visible": false,
            "url": "./glb/poly6_optimized.glb"
        },
        "transformation": [
                -0.019314866777405213,
                0,
                -0.9370573891901756,
                0,
                0,
                1.422224355224052,
                0,
                0,
                0.9370573891901756,
                0,
                -0.019314866777405213,
                0,
                -15.571041825873646,
                -0.8187535535381816,
                -0.9419475085183766,
                1
        ]
    },
    "Poly 10": {
        "raw": {
            "visible": true,
            "url": "./glb/poly10.glb"
        },
        "optimized": {
            "visible": false,
            "url": "./glb/poly10_optimized.glb"
        },
        "transformation": [
                0.018758017899008356,
                0,
                -1.4237962500358017,
                0,
                0,
                1,
                0,
                0,
                0.999913225588832,
                0,
                0.01317350722238442,
                0,
                -103.73323038567928,
                -1.3964948746165284,
                0.6711253983300178,
                1
        ]
    },
    "Poly 2": {
        "raw": {
            "visible": true,
            "url": "./glb/poly2.glb"
        },
        "optimized": {
            "visible": false,
            "url": "./glb/poly2_optimized.glb"
        },
        "transformation": [
                -0.905618977209684,
                0,
                -0.00811413535496553,
                0,
                0,
                0.905655326862749,
                0,
                0,
                0.00811413535496553,
                0,
                -0.905618977209684,
                0,
                -25.245994233283213,
                5.768629870132541,
                29.063212852292143,
                1
        ]
    }
  }

  for (const key in controls) {
    const control = controls[key];
    for (const subKey in control) {
        const subControl = control[subKey];
        if(subKey === 'optimized' || subKey === 'raw') {
            await digitalTwin.scans.load(subControl.url);
            await digitalTwin.transform.select(subControl.url);
            await digitalTwin.transform.setTransform(control.transformation);
            if (!subControl.visible) {
                console.log(subControl.url);
                await digitalTwin.scans.setVisibility(false, [subControl.url]);
            }
        }
    }
  }
  
  const gui = new dat.GUI();
  const guiControls = {
    optimize: false,
  }

  const modelFolder = gui.addFolder('Scan Viewer');

    // for (const key in controls) {
    //     const control = controls[key];
    //     const folder = modelFolder.addFolder(key);
    //     folder.add(control.optimized, 'visible').name('Optimize').onChange(async () => {
    //         console.log(control);
    //         if(control.optimized.visible) {
    //             await digitalTwin.scans.setVisibility(true, [control.optimized.url]);
    //             await digitalTwin.scans.setVisibility(false, [control.raw.url]);
    //         } else {
    //             await digitalTwin.scans.setVisibility(true, [control.raw.url]);
    //             await digitalTwin.scans.setVisibility(false, [control.optimized.url]);
    //         }
    //     });
    // }
  modelFolder.add(guiControls, 'optimize').name('Optimize').onChange(async () => {
    if(guiControls.optimize) {
        for (const key in controls) {
            const control = controls[key];
            await digitalTwin.scans.setVisibility(true, [control.optimized.url]);
            await digitalTwin.scans.setVisibility(false, [control.raw.url]);
        }
    } else {
        for (const key in controls) {
            const control = controls[key];
            await digitalTwin.scans.setVisibility(true, [control.raw.url]);
            await digitalTwin.scans.setVisibility(false, [control.optimized.url]);
        }
    }
  });

</script>
</body>
</html>
